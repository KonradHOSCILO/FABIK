{% extends "base.html" %}

{% block title %}Strona G≈Ç√≥wna{% endblock %}

{% block content %}
    <div class="container mt-4">

        <!-- Nag≈Ç√≥wek -->
        <div class="w-100 px-4">
            <h4 class="text-center fw-bold mb-4">Strona G≈Ç√≥wna</h4>
        </div>

        <!-- Kafelki -->
        <div class="card shadow p-4">
    <div class="row g-3 align-items-stretch"> <!-- dodano align-items-stretch -->

        <!-- Pierwszy kafelek -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100"> <!-- dodano h-100 -->
                <div class="card-body d-flex flex-column justify-content-between">
                    <div class="d-flex align-items-center flex-wrap">
                        <div>
                            <strong>Status patrolu {{ user.username }}:</strong>
                            <span id="patrol-status" data-patrol-number="{{ user.username|lower }}">≈Åadowanie...</span>
                        </div>
                        <div class="dropdown ms-3">
                            <button class="btn btn-sm btn-primary dropdown-toggle" type="button"
                                    id="patrolStatusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                Zmie≈Ñ status
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="patrolStatusDropdown">
                                <li><a class="dropdown-item" href="javascript:void(0);" onclick="setStatus('wolny')">Wolny</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0);" onclick="setStatus('w_drodze')">W drodze</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0);" onclick="setStatus('awaria')">Awaria</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0);" onclick="setStatus('poza_pojazdem')">Poza pojazdem</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drugi kafelek -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100"> <!-- dodano h-100 -->
                <div class="card-body d-flex flex-column justify-content-between">
                    <p class="text-secondary mb-1">Liczba przeprowadzonych interwencji dzisiejszego dnia</p>
                    <h5 class="fw-bold">{{ interwencje_count }}</h5>
                </div>
            </div>
        </div>

    </div>
</div>


            <!-- Przycisk -->
            <div class="mt-3">
                <form method="post" action="{% url 'rozpocznij_interwencje' %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary w-100 py-3">Rozpocznij interwencjƒô</button>
                </form>
            </div>

            <!-- Pozosta≈Çe opcje -->
            <div class="row g-3 mt-4 mb-4">

                <div class="mt-4 mb-4">
    <h4>Komunikaty</h4>

    <div class="card shadow-sm mb-3">
        <div class="card-body p-3" id="messages-box" style="height: 250px; overflow-y: auto;">
            <div class="d-flex flex-column gap-2" id="messages-container">
                <p class="text-muted mb-0">≈Åadowanie wiadomo≈õci...</p>
            </div>
        </div>
    </div>

    <form id="send-message-form" class="d-flex">
        <input type="text" class="form-control me-2" id="message-input" placeholder="Wpisz wiadomo≈õƒá..." required>
        <button type="submit" class="btn btn-primary">Wy≈õlij</button>
    </form>
</div>

                <div class="col-md-6">
                    <a href="/historia_html" class="btn btn-primary w-100" role="button">Sprawd≈∫ historiƒô</a>
                </div>

            </div>

            <!-- Przycisk -->
            <div class="mt-5">
                <form method="post" action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-secondary w-100">Wyloguj siƒô</button>
                </form>
            </div>

        </div>

    </div>

    <script>


        document.getElementById('send-message-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            fetch("/api/send_message/", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    tresc: text,
                    odbiorca: "dyzurny"  // üëà Zawsze wysy≈Çamy do dy≈ºurnego
                })
            })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    input.value = "";
                    console.log("Wiadomo≈õƒá wys≈Çana:", data);
                    loadMessagesForPatrol(); // ‚¨ÖÔ∏è od≈õwie≈º
                })
                .catch(error => {
                    console.error("B≈ÇƒÖd wysy≈Çania:", error);
                    alert("Nie uda≈Ço siƒô wys≈Çaƒá wiadomo≈õci.");
                });
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function setStatus(status) {
            const patrolStatusElem = document.getElementById('patrol-status');
            const patrolNumber = patrolStatusElem.getAttribute('data-patrol-number');

            fetch('/patrol/status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({patrol_number: patrolNumber, new_status: status})
            })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.status === "ok") {
                        patrolStatusElem.innerText = data.display;
                        console.log("Status zaktualizowany!");
                    } else {
                        alert("B≈ÇƒÖd: " + (data.error || "Nieznany b≈ÇƒÖd"));
                    }
                })
                .catch(error => {
                    console.error("B≈ÇƒÖd:", error);
                    alert("B≈ÇƒÖd po≈ÇƒÖczenia: " + error.message);
                });
        }

        function refreshStatus() {
            const patrolStatusElem = document.getElementById('patrol-status');
            const patrolNumber = patrolStatusElem.getAttribute('data-patrol-number');

            fetch(`/patrol/status/?patrol_number=${encodeURIComponent(patrolNumber)}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.status === "ok") {
                        patrolStatusElem.innerText = data.display || "brak statusu";
                    } else {
                        console.warn("B≈ÇƒÖd pobierania statusu:", data.error);
                    }
                })
                .catch(error => {
                    console.error("B≈ÇƒÖd pobierania statusu:", error);
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const patrolStatusElem = document.getElementById('patrol-status');
            patrolStatusElem.innerText = '≈Åadowanie...';

            // Natychmiastowe pobranie statusu po za≈Çadowaniu
            refreshStatus();

            // Od≈õwie≈ºanie statusu co 1 sekunde
            setInterval(refreshStatus, 1000);
            loadMessagesForPatrol();
            setInterval(loadMessagesForPatrol, 2000);
        });
        let firstLoad = true;

function loadMessagesForPatrol() {
    const patrolId = "{{ username|escapejs }}".toLowerCase();
    console.log("Patrol ID:", patrolId);

    const container = document.getElementById("messages-container");

    // Poka≈º "≈Åadowanie wiadomo≈õci..." tylko przy pierwszym wywo≈Çaniu
    if (firstLoad) {
        container.innerHTML = "<p class='text-muted'>≈Åadowanie wiadomo≈õci...</p>";
        firstLoad = false;
    }

    fetch("/api/get_messages/all/")
        .then(res => {
            if (!res.ok) throw new Error(`B≈ÇƒÖd HTTP: ${res.status}`);
            return res.json();
        })
        .then(messages => {
            console.log("Wszystkie wiadomo≈õci z API:", messages);

            // Czy≈õcimy i pokazujemy wiadomo≈õci dopiero po pobraniu
            container.innerHTML = "";

            const filtered = messages.filter(msg => {
                const nadawca = (msg.nadawca || "").toLowerCase();
                const odbiorca = (msg.odbiorca || "").toLowerCase();

                const match =
                    (nadawca === patrolId && odbiorca === "dyzurny") ||
                    (nadawca === "dyzurny" && odbiorca === patrolId);

                if (match) {
                    console.log("‚úÖ Pasuje:", msg);
                } else {
                    console.log("‚õî Nie pasuje:", { nadawca, odbiorca, patrolId });
                }

                return match;
            });

            if (!filtered.length) {
                container.innerHTML = "<p class='text-muted'>Brak wiadomo≈õci</p>";
                return;
            }

            filtered.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            for (const msg of filtered) {
    const time = new Date(msg.timestamp).toLocaleTimeString("pl-PL", { hour12: false });
    const from = msg.nadawca === "dyzurny" ? "Dy≈ºurny" : msg.nadawca;
    const to = msg.odbiorca === "dyzurny" ? "Dy≈ºurny" : msg.odbiorca;

    const div = document.createElement("div");
    div.className = "p-2 mb-2 rounded text-break";

    const prefix = `${time}, ${from} ‚Üí ${to}: `;
    const messageText = document.createElement("span");
    messageText.textContent = msg.tresc;

    const header = document.createElement("div");
    header.className = "fw-semibold mb-1";
    header.textContent = prefix;

    if (msg.nadawca === "dyzurny") {
        div.classList.add("bg-info-subtle", "text-dark"); // üëà ≈Çagodniejsze ni≈º bg-primary
    } else {
        div.classList.add("bg-light", "text-dark");
    }

    div.appendChild(header);
    div.appendChild(messageText);
    container.appendChild(div);
}

        })
        .catch(err => {
            console.error("‚ùå B≈ÇƒÖd ≈Çadowania wiadomo≈õci:", err);
            container.innerHTML = `<p class="text-danger">B≈ÇƒÖd ≈Çadowania wiadomo≈õci: ${err.message}</p>`;
        });
}



    </script>

    <script>
    console.log("Z backendu username =", "{{ username }}");
    </script>

{% endblock %}