{% extends "base.html" %}

{% block title %}Strona Główna{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- Nagłówek -->
  <div class="w-100 px-4">
    <h4 class="text-center fw-bold mb-4">Strona Główna</h4>
  </div>

  <!-- Kafelki -->
  <div class="card shadow p-4">

    <div class="row g-3">

      <!-- Status patrolu przeniesiony tutaj zamiast napisu "W trakcie Dokumentacji" -->
      <div class="col-md-6">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center flex-wrap">
              <div>
                <strong>Status patrolu {{ user.username }}:</strong>
                <span id="patrol-status">Ładowanie...</span>
              </div>
              <div class="dropdown ms-3">
                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="patrolStatusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  Zmień status
                </button>
                <ul class="dropdown-menu" aria-labelledby="patrolStatusDropdown">
                  <li><a class="dropdown-item" href="#" onclick="setStatus('wolny'); return false;">Wolny</a></li>
                  <li><a class="dropdown-item" href="#" onclick="setStatus('w_drodze'); return false;">W drodze</a></li>
                  <li><a class="dropdown-item" href="#" onclick="setStatus('awaria'); return false;">Awaria</a></li>
                  <li><a class="dropdown-item" href="#" onclick="setStatus('poza_pojazdem'); return false;">Poza pojazdem</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pozostawiamy drugi kafelek bez zmian -->
      <div class="col-md-6">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <p class="text-secondary mb-1">
              Liczba przeprowadzonych interwencji w trakcie trwania sesji
            </p>
            <h5 class="fw-bold">5</h5>
          </div>
        </div>
      </div>

    </div>

    <!-- Przycisk -->
    <div class="mt-3">
      <form method="post" action="{% url 'rozpocznij_interwencje' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary w-100 py-3">Rozpocznij interwencję</button>
      </form>
    </div>

    <!-- Pozostałe opcje -->
    <div class="row g-3 mt-4 mb-4">

      <h4>Pozostałe</h4>

      <div class="col-md-6">
        <a href="/historia_html" class="btn btn-primary w-100" role="button">Sprawdź historię</a>
      </div>

      <div class="col-md-6">
        <a href="/lista_osoby_pojazdy_html" class="btn btn-primary w-100" role="button">Wyszukaj osobę lub pojazd</a>
      </div>

    </div>

    <!-- Przycisk -->
    <div class="mt-5">
        <form method="post" action="{% url 'logout' %}">
         {% csrf_token %}
            <button type="submit" class="btn btn-secondary w-100">Wyloguj się</button>
        </form>
    </div>

  </div>

</div>

<!-- Bootstrap 5 dla dropdownów (jeśli nie masz, dodaj do base.html/poniżej) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
function setStatus(status) {
    fetch("{% url 'set_patrol_status' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}",
        },
        body: "status=" + encodeURIComponent(status)
    })
    .then(response => response.json())
    .then(data => {
        if(data.status === "ok"){
            document.getElementById('patrol-status').innerText = data.display;
        } else {
            alert("Błąd przy zmianie statusu: " + (data.error || ""));
        }
    })
    .catch(() => {
        alert("Błąd połączenia z serwerem");
    });
}

// Pobierz status przy starcie
window.addEventListener("DOMContentLoaded", function () {
    fetch("{% url 'set_patrol_status' %}", {method: "GET"})
    .then(response => response.json())
    .then(data => {
        if(data.status === "ok" && data.display){
            document.getElementById('patrol-status').innerText = data.display;
        }
    });
});
</script>
{% endblock %}