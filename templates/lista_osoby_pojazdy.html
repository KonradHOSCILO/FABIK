<!DOCTYPE html>
{% load static %}
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interwencja</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
</head>

<body class="bg-light">
  <div class="container mt-5">
    <div class="d-flex align-items-center mb-3">
      <a href="{% url 'strona_glowna_html' %}" class="btn bg-white shadow-sm border rounded-3 px-3">
        <i class="bi bi-arrow-left"></i>
      </a>
      <h4 class="text-center flex-grow-1 fw-bold">Lista osób i pojazdów</h4>
    </div>

    <div class="card shadow p-4">
      <div class="row justify-content-center g-4">

        <!-- Panel 1 - Szukaj osoby -->
        <div class="col-md-5">
          <h4 class="mt-3 mb-0 text-center">Wyszukaj osobę</h4>
          <form id="osobaForm">
            <div class="mb-3">
              <label for="pesel" class="form-label fw-bold"></label>
              <input type="text" class="form-control" id="pesel" placeholder="Podaj PESEL" />
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary">Sprawdź</button>
            </div>
          </form>
          <div class="mt-4" id="wynik_osoba"></div>
        </div>

        <!-- Panel 2 - Szukaj pojazdu -->
        <div class="col-md-5">
          <h4 class="mt-3 mb-0 text-center">Wyszukaj pojazd</h4>
          <form id="pojazdForm">
            <div class="mb-3">
              <label for="numer_rejestracyjny" class="form-label fw-bold"></label>
              <input type="text" class="form-control" id="numer_rejestracyjny" placeholder="Podaj Numer Rejestracyjny" />
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary">Sprawdź</button>
            </div>
          </form>
          <div class="mt-4" id="wynik_pojazd"></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    document.getElementById("osobaForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const pesel = document.getElementById("pesel").value.trim();
      const wynikDiv = document.getElementById("wynik_osoba");

      if (!pesel) {
        wynikDiv.innerHTML = "<div class='alert alert-danger'>Wprowadź PESEL.</div>";
        return;
      }

      const params = new URLSearchParams();
      params.append("pesel", pesel);

      try {
        const response = await fetch(`/osoba/?${params.toString()}`);
        const data = await response.json();

        if (response.ok) {
          if (Array.isArray(data) && data.length > 0) {
            const osoba = data[0];
            let lista = '';
            const sortedKeys = Object.keys(osoba).sort();

            for (const key of sortedKeys) {
              const value = osoba[key];
              let valStr = '';

              if (!value) continue;

              if (value?.arrayValue?.values) {
                valStr = value.arrayValue.values
                  .map(v => v.stringValue || v.integerValue || v.booleanValue)
                  .join(", ");
              } else if (value?.stringValue) {
                valStr = value.stringValue;
              } else if (value?.integerValue) {
                valStr = value.integerValue;
              } else if (value?.booleanValue !== undefined) {
                valStr = value.booleanValue;
              } else {
                valStr = JSON.stringify(value);
              }

              lista += `<li class="list-group-item"><strong>${key}:</strong> ${valStr}</li>`;
            }

            wynikDiv.innerHTML = `
              <div class="card p-3">
                <h5>Dane osoby:</h5>
                <ul class="list-group list-group-flush">
                  ${lista}
                </ul>
              </div>
            `;
          } else {
            wynikDiv.innerHTML = `<div class='alert alert-warning'>Nie znaleziono osoby.</div>`;
          }
        } else {
          wynikDiv.innerHTML = `<div class='alert alert-danger'>Błąd: ${data.error || 'Nieznany błąd'}</div>`;
        }
      } catch (err) {
        wynikDiv.innerHTML = `<div class='alert alert-danger'>Wystąpił błąd podczas pobierania danych.</div>`;
      }
    });

    document.getElementById("pojazdForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const nr = document.getElementById("numer_rejestracyjny").value.trim();
      const wynikDiv = document.getElementById("wynik_pojazd");

      if (!nr) {
        wynikDiv.innerHTML = "<div class='alert alert-danger'>Wprowadź numer rejestracyjny.</div>";
        return;
      }

      const params = new URLSearchParams();
      params.append("numer_rejestracyjny", nr);

      try {
        const response = await fetch(`/pojazd/?${params.toString()}`);
        const data = await response.json();

        if (response.ok) {
          if (Array.isArray(data) && data.length > 0) {
            const pojazd = data[0];
            let lista = '';
            const sortedKeys = Object.keys(pojazd).sort();

            for (const key of sortedKeys) {
              const value = pojazd[key];
              let valStr = '';

              if (!value) continue;

              if (value?.arrayValue?.values) {
                valStr = value.arrayValue.values
                  .map(v => v.stringValue || v.integerValue || v.booleanValue)
                  .join(", ");
              } else if (value?.stringValue) {
                valStr = value.stringValue;
              } else if (value?.integerValue) {
                valStr = value.integerValue;
              } else if (value?.booleanValue !== undefined) {
                valStr = value.booleanValue;
              } else {
                valStr = JSON.stringify(value);
              }

              lista += `<li class="list-group-item"><strong>${key}:</strong> ${valStr}</li>`;
            }

            wynikDiv.innerHTML = `
              <div class="card p-3">
                <h5>Dane pojazdu:</h5>
                <ul class="list-group list-group-flush">
                  ${lista}
                </ul>
              </div>
            `;
          } else {
            wynikDiv.innerHTML = `<div class='alert alert-warning'>Nie znaleziono pojazdu.</div>`;
          }
        } else {
          wynikDiv.innerHTML = `<div class='alert alert-danger'>Błąd: ${data.error || 'Nieznany błąd'}</div>`;
        }
      } catch (err) {
        wynikDiv.innerHTML = `<div class='alert alert-danger'>Wystąpił błąd podczas pobierania danych.</div>`;
      }
    });
  </script>
</body>
</html>
